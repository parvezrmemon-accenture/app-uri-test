<!DOCTYPE html>
<html>

<head>
    <link rel="manifest" href="./manifest.json">
    <script src="./sw.js" referrerpolicy="no-referrer"></script>
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <style>
        .commonPadding {
            padding-left: 10px;
        }
    </style>
</head>

<body>

    <div>
        <h1>
            Testing Page
        </h1>
        <div class="commonPadding">
            <h2>1. Opening PWA from PWA</h2>
            <h3>
                Selected window open option: windowOpenOption and PWA URL:" "
                pwaUrl
            </h3>
            <h4>Available option: _blank, _parent, _self, _top</h4>
            <input type="text" placeholder="Enter window option to open URL " name="windowOpenOption" />
            <input type="text" placeholder="Enter PWA URL" name="pwaUrl" />
            <h3>Current Selection for PWA</h3>
            <button>
                Open PWA
            </button>
            <a href=pwaUrl target=windowOpenOption>
                `a` Tag to Open PWA
            </a>
        </div>
        <div class="commonPadding">
            <h2>
                2. Button to push out to browser like (Safari, Chrome, Edge)
            </h2>
            <input type="text" placeholder="Enter browser" name="browser" />
            <input type="text" placeholder="Enter web URL" name="webUrl" />
            <button>
                Open in browser
            </button>
            <a href="mailto:new@gmail.com">Click me</a>
        </div>
        <div class="commonPadding">
            <h2>3. Open native-app with URI</h2>
            <input type="text" placeholder="Enter Native App URI for test" name="nativeAppUri" />
            <button onClick=updateNativeAppUri data-testid="nativeUriTestBtn">
                Test native app URI
            </button>

            <h3>used URI: nativeApp</h3>
            <button>
                Open nativeApp as Native-App
            </button>
        </div>
        <div class="commonPadding">
            <h2>4. Open SharePoint URL inside PWA (iFrame)</h2>
            <input type="text" placeholder="Enter URL to test in iFrame" name="iframeUrl" />
            <button>
                Test native app URI
            </button>
            <h3>Testing for iframeInput</h3>
        </div>
        <div class="commonPadding">
            <h2>
                5. Additional test option; relation attribute current selection" "
                external
            </h2>
            <input type="text" placeholder="Enter rel value" name="rel" />
            <button>
                external url link
            </button>
            <a href=externalLink rel=external>
                Enable nbnco
            </a>
        </div>
        <div class="commonPadding">
            <h2>
                6. Another test optin; test time out
            </h2>
            <a href=externalLink>Enable NBNCO</a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://nbnco.appiancloud.com/suite/sites/service-delivery-one', 1);">
                Appian </a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://ebusiness.nbnco.net.au/OA_HTML/OA.jsp?OAFunc=OAHOMEPAGE', 2);"> e
                Business </a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://serkohrgv2.au.hrgworldwide.com/login/AUNBNCO', 3);">
                Zeno </a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://go.servicemax.io/calendar', 4);">
                SMAX Go </a>
        </div>
        <div class="commonPadding">
            <h2>
                7. Redirecting to download if App is not installed
            </h2>
            <button data-testid="ifAppInstalledTestBtn" onClick="test();">com.salesforce.fieldservice://; Native
                App</button>
        </div>
        <input type="text" value="" id="appUri" />

        <button onClick="openMinWin();">Open Min windows</button>
    </div>
</body>

<script>

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/app-uri-test/sw.js')
            .then(reg => console.log('service worker registered'))
            .catch(err => console.log('service worker not registered', err))
    }
    var myWindow;
    var openedWindows = {}

    function openMinWin() {
        console.log(myWindow)
        if (myWindow && !myWindow.closed) {
            setTimeout(() => {
                alert('Already opened');
                myWindow.focus(); // focus on existing window
            }, 100); // delay the call to focus by 100 milliseconds

        } else {
            myWindow = window.open("https://www.plus2net.com/javascript_tutorial/window-close.php", "Ratting", "width=550,height=170,0,top=260,status=0,");
        }
    }

    function openSmallWin(url, name) {
        const isAlreadyOpened = openedWindows[name];
        console.log('isAlreadyOpened', isAlreadyOpened)

        if (isAlreadyOpened && !isAlreadyOpened.closed) {
            setTimeout(() => {
                alert('Already opened');
                isAlreadyOpened.window.focus(); // focus on existing window
            }, 100); // delay the call to focus by 100 milliseconds

        } else {
            let newWindow = window.open(url, name, 'toolbar=no,location=no, directories=no, status=yes, menubar=no, resizable=yes, copyhistory=no, scrollbars=no');
            const newWinObj = { [name]: newWindow }
            openedWindows = { ...openedWindows, ...newWinObj }
        }
    }

    function test() {
        const customUri = document.getElementById('appUri').value || 'svmxgo://';
        const appScheme = customUri;
        const webURL = "https://www.google.com/"

        window.location = customUri;

        setTimeout(function () {
            // alert(document.visibilityState)
            alert(document.hasFocus())
            // alert(document.visibilityState === 'visible')
            if (document.hasFocus()) {
                window.location = webURL;
            }
            // If the app was not opened, redirect the user to the app store or web URL
            // Testing
            // if (document.hidden || document.webkitHidden) {
            // window.location = webURL;
        }, 10000);

        // window.location = customUri;
        // const timeout = setTimeout(function () {
        //     window.location = webURL;
        // }, 1000); // Wait for 1 second and then redirect to the web version
        // window.addEventListener('blur', function () {
        //     clearTimeout(timeout); // Cancel the timeout if the external app was successfully launched
        // });
        // let count = 1;
        // window.addEventListener('focus', function () {
        //     if (count === 1) {
        //         alert('check')
        //         count = 2;
        //     }
        // });

        // if (window.matchMedia('(display-mode: standalone)').matches) {
        // window.open(customUri, '_self', 'noopener, noreferrer');

        // // Wait for a short period of time and check if the app was opened
        // setTimeout(function () {
        //     alert(document.hasFocus())
        //     alert(window.location.href)
        //     // If the app was not opened, redirect the user to the app store or web URL
        //     // Testing
        //     // if (document.hidden || document.webkitHidden) {
        //     if (document.hasFocus()) {
        //         window.open(webURL, '_self', 'noopener, noreferrer');
        //     }
        // }, 10000);
        // }
        // else {
        //     window.open(customUri, '_blank', 'noopener, noreferrer');
        // }
    }

</script>

</html>