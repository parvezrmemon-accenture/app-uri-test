<!DOCTYPE html>
<html>

<head>
    <link rel="manifest" href="./manifest.json">
    <script src="./sw.js" referrerpolicy="no-referrer"></script>
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <style>
        .commonPadding {
            padding-left: 10px;
        }
    </style>
</head>

<body>

    <div class="commonPadding">
        <h1>
            Testing Page
        </h1>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://nbnco.appiancloud.com/suite/sites/service-delivery-one', 1);">
                Appian </a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://ebusiness.nbnco.net.au/OA_HTML/OA.jsp?OAFunc=OAHOMEPAGE', 2);"> e
                Business </a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://serkohrgv2.au.hrgworldwide.com/login/AUNBNCO', 3);">
                Zeno </a>
        </div>
        <div class="commonPadding">
            <a href="javascript:openSmallWin('https://go.servicemax.io/calendar', 4);">
                SMAX Go </a>
        </div>
        <div class="commonPadding">
            <h2>
                7. Redirecting to download if App is not installed
            </h2>
            <input type="text" value="" id="appUri" />
            <button data-testid="ifAppInstalledTestBtn" onClick="test();">com.salesforce.fieldservice://; Native
                App</button>
        </div>
        <br /><br />
        <div class="commonPadding">
            <button onClick="openMinWin();">Open Min windows</button>
        </div>
    </div>
</body>

<script>

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/app-uri-test/sw.js')
            .then(reg => console.log('service worker registered'))
            .catch(err => console.log('service worker not registered', err))
    }
    var myWindow;
    var openedWindows = {}

    function openMinWin() {
        console.log(myWindow)
        if (myWindow && !myWindow.closed) {
            setTimeout(() => {
                alert('Already opened');
                myWindow.focus(); // focus on existing window
            }, 100); // delay the call to focus by 100 milliseconds

        } else {
            myWindow = window.open("https://www.plus2net.com/javascript_tutorial/window-close.php", "Ratting", "width=550,height=170,0,top=260,status=0,");
        }
    }

    function openSmallWin(url, name) {
        const isAlreadyOpened = openedWindows[name];
        const urlRel = 'noopener, noreferrer';

        if ('serviceWorker' in navigator && window.matchMedia('(display-mode: standalone)').matches) {
            alert("Yes it's PWA")
            alert(getOperatingDevice().device)
        }
        if (isAlreadyOpened && !isAlreadyOpened.closed) {
            setTimeout(() => {
                alert('Already opened');
                isAlreadyOpened.window.focus(); // focus on existing window
            }, 100); // delay the call to focus by 100 milliseconds

        } else {
            let newWindow = window.open(url, name, 'noopener, noreferrer,toolbar=no,location=no, directories=no, status=yes, menubar=no, resizable=yes, copyhistory=no, scrollbars=no');
            setTimeout(function () { newWindow.document.title = 'my new title'; }, 1000);
            const newWinObj = { [name]: newWindow }
            openedWindows = { ...openedWindows, ...newWinObj }
        }
    }

    function test() {
        const customUri = document.getElementById('appUri').value || 'svmxgo://';
        const appScheme = customUri;
        const webURL = "https://www.google.com/"

        window.location = customUri;

        setTimeout(function () {
            if (document.hasFocus()) {
                window.open(webURL, '_blank');
            }
        }, 10000);

        // window.location = customUri;
        // const timeout = setTimeout(function () {
        //     window.location = webURL;
        // }, 1000); // Wait for 1 second and then redirect to the web version
        // window.addEventListener('blur', function () {
        //     clearTimeout(timeout); // Cancel the timeout if the external app was successfully launched
        // });
        // let count = 1;
        // window.addEventListener('focus', function () {
        //     if (count === 1) {
        //         alert('check')
        //         count = 2;
        //     }
        // });

        // if (window.matchMedia('(display-mode: standalone)').matches) {
        // window.open(customUri, '_self', 'noopener, noreferrer');

        // // Wait for a short period of time and check if the app was opened
        // setTimeout(function () {
        //     alert(document.hasFocus())
        //     alert(window.location.href)
        //     // If the app was not opened, redirect the user to the app store or web URL
        //     // Testing
        //     // if (document.hidden || document.webkitHidden) {
        //     if (document.hasFocus()) {
        //         window.open(webURL, '_self', 'noopener, noreferrer');
        //     }
        // }, 10000);
        // }
        // else {
        //     window.open(customUri, '_blank', 'noopener, noreferrer');
        // }
    }

    function getOperatingDevice() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        let isMobile = false;
        let device = "Desktop";

        // Windows Phone must come first because its UA also contains "Android"
        if (/windows phone/i.test(userAgent)) {
            isMobile = true;
            device = "Windows Phone";
        }

        if (/android/i.test(userAgent)) {
            isMobile = true;
            device = "Android";
        }

        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            isMobile = true;
            device = "iOS";
        }
        return {
            isMobile: isMobile,
            device: device,
        };
    }

</script>

</html>