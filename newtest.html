<!DOCTYPE html>
<html>

<head>
    <link rel="manifest" href="./manifest.json">
    <script src="./sw.js" referrerpolicy="no-referrer"></script>
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <style>
        .commonPadding {
            padding-left: 10px;
        }
    </style>
</head>

<body>
    <div class="commonPadding">
        <h2>
            7. Redirecting to download if App is not installed
        </h2>
        <button data-testid="ifAppInstalledTestBtn" onClick="test();">com.salesforce.fieldservice://; Native
            App</button>
    </div>
    <input type="text" value="" id="appUri" />
</body>

<script>
    const OPEN_APP_TIMEOUT = 6000; // Set timeout to 2 seconds

    function test() {
        // Trigger the native app to open here
        const customUri = document.getElementById('appUri').value || 'svmxgo://';
        const webURL = "https://www.google.com/"

        // window.location = customUri;
        window.location.replace(customUri);
    }

    function handleBlur() {
        // This event listener fires when the app is opened or an error prompt is shown
        const startTime = Date.now();
        window.removeEventListener('blur', handleBlur);

        // Set a timer to check the visibility state after the app is opened or error prompt is shown
        setTimeout(() => {
            if (document.visibilityState === 'visible' && document.hasFocus()) {
                // User did not open the native app
                alert('User did not open the native app in here');
            } else {
                // User may have opened the native app, check again after the prompt is dismissed
                const promptDismissedHandler = () => {
                    if (document.visibilityState === 'visible' && document.hasFocus()) {
                        // User did not open the native app
                        alert('User did not open the native app');
                    } else {
                        // User opened the native app and then returned to the browser
                        alert('User opened the native app');
                    }
                    document.removeEventListener('visibilitychange', promptDismissedHandler);
                };

                document.addEventListener('visibilitychange', promptDismissedHandler);
            }
        }, OPEN_APP_TIMEOUT);
    }

    window.addEventListener('blur', handleBlur);

    // function test() {
    //     const customUri = document.getElementById('appUri').value || 'svmxgo://';

    //     window.open(customUri, '_self', 'noopener, noreferrer');

    //     setTimeout(function () {
    //         alert(document.visibilityState)
    //     }, 5000)
    // }
    // function handleBlur() {
    //     console.log('Native app may have been opened');
    //     window.removeEventListener('blur', handleBlur);
    //     document.removeEventListener('visibilitychange', handleVisibilityChange);
    // }

    // function handleVisibilityChange() {
    //     if (document.visibilityState === 'visible') {
    //         console.log('Error message was shown');
    //         window.removeEventListener('blur', handleBlur);
    //         document.removeEventListener('visibilitychange', handleVisibilityChange);
    //     }
    // }

    // window.addEventListener('blur', handleBlur);
    // document.addEventListener('visibilitychange', handleVisibilityChange);

</script>

</html>